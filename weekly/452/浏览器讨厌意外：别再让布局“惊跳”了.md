原文：[The Browser Hates Surprises](https://frontendmasters.com/blog/the-browser-hates-surprises/)
翻译：TUARAN
欢迎关注 [{{前端周刊}}](https://github.com/TUARAN/frontend-weekly-digest-cn)，每周更新国外论坛的前端热门文章，紧跟时事，掌握前端技术动态。

# 浏览器讨厌意外：别再让布局“惊跳”了



作者：Durgesh Rajubhai Pawar

发布时间：2026-02-06

我们常把浏览器当成一块画布：给它 HTML/CSS，它就把像素“画”出来。但作者提醒：这套心智模型不太对——浏览器更像一个**约束求解器（constraint solver）**。

你给出规则（HTML 与 CSS），浏览器就根据规则计算几何与布局；当你一次性把信息交齐，体验会很稳定、很顺滑。相反，如果图片晚到、滚动条突然出现、字体替换导致尺寸变化，浏览器不得不在渲染过程中反复重新计算几何，就会出现我们熟悉的 CLS（累计布局偏移）——更直白地说：**卡顿与“惊跳”（jank）**。

核心原则：不要“惊吓”浏览器；尽量提前给足约束与空间预留。

## 一个“敌对（Hostile）”页面的四种意外

作者用一个 Demo（通过 `setTimeout` 模拟）展示四类常见“意外”，它们在真实网站里很常见：

1) **吸顶头部遮挡锚点**：点击“跳到某节”后，滚动位置数学上没错，但标题被 fixed header 盖住。

2) **爆米花式加载**：文本与图片各自加载，页面先跳一次（文本），再跳一次（图片）。

3) **图片未预留尺寸**：图片初始尺寸被当成 0×0，等资源到达才把文本顶开。

4) **滚动条突然出现**：当内容变长需要滚动条时（Windows/Linux 更典型），视口可用宽度变化，导致整体居中布局横向位移。

（原文包含 CodePen embed，这里省略 embed，只保留结论与修复要点。）

## 为什么会这样：渲染管线与 Reflow

浏览器渲染大致经历：

- Parse：解析 HTML/CSS
- Layout：计算每个盒子的几何
- Paint：绘制像素

当你先塞文本、再塞图片、再突然出现滚动条时，每一步都会迫使浏览器从 Paint 回到 Layout 重新算一遍，再 Paint 一遍——这就是 **Reflow**。它不仅耗 CPU，更直接破坏用户正在看的画面稳定性。

作者把这类模式称为：从“被动渲染（Reactive Rendering）”转向“编排式渲染（Orchestrated Rendering）”。

## 解决方案：和浏览器做四个“协商”

### 1) 坐标协商：用 `scroll-margin-top` 解决吸顶遮挡

浏览器滚动到锚点时并不“错”，它只是滚到元素的数学顶部；问题在于 fixed header 不在正常文档流里。

```css
:target {
  /* 告诉浏览器：滚到这里时，顶部留出 6rem */
  scroll-margin-top: 6rem;
}
```

### 2) 空间协商：提前预留滚动条空间

方案 A（兼容性最好）：

```css
html {
  overflow-y: scroll;
}
```

方案 B（更现代）：

```css
html {
  scrollbar-gutter: stable;
}
```

### 3) 布局预订：用 `aspect-ratio` 给图片“占座”

浏览器默认会把图片当成 0×0，直到下载到足够信息才能确定尺寸。通过 `aspect-ratio`，你可以让浏览器在布局阶段就算出最终盒子大小。

```css
img {
  width: 100%;
  height: auto;
  aspect-ratio: 16 / 9;
  object-fit: cover;
}
```

### 4) 编排承诺：用 `Promise.all` 合并状态更新

与其分三次更新 UI（三次 reflow），不如等“关键演员”都到齐再一次性更新：

```js
// 不要只是 fetch；要“编排”
async function loadScene() {
  const results = await Promise.all([
    fetch("/api/text"),
    fetch("/api/image"),
  ]);

  // 只更新一次：一次 reflow，一次 paint
  setFullScene(results);
}
```

## 结语

作者的总结很像一句“性能产品化”的建议：优化不只是让页面更快，更是让它加载得更**平静（calmer）**。

每个滚动 bug、每次图片抖动、每个布局偏移，都说明我们没有在“对的时间”给浏览器“它需要的信息”。

不要惊吓浏览器；从预留空间开始。
